<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Тест чата</title>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" type="text/javascript"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>    
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.4/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
    <div id="app">
        <div class="container-fluid">
            <div class="row" style="margin-bottom: 2em;">
                <input type="text" v-model="login" placeholder="login" />
                <input type="text" v-model="password" placeholder="password" />
                <input type="button" value="авторизоваться" @click="auth" />
            </div>
            <div class="row">
                <test-chat ref="chat1" class="col" 
                    :key="'1'" 
                    :user="'admin1'"
                ></test-chat>
                <test-chat ref="chat2" class="col" 
                    :key="'2'" 
                    :user="'admin2'"
                ></test-chat>
            </div>
        </div>        
    </div>

    <script type="text/javascript">
        const dialog = '9WXUVVT14NY75YVOAS0D9CHKFSFLDHJ6'

        Vue.component('test-chat', {
            template: `
                    <form>
                        <div class="row">
                            <div>Сообщения:<br></div>
                            <div class="row" v-for="it in messages"> 
                                <div class="col">[{{it.date}}] {{it.from}} - {{it.message}}</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <textarea class="form-control" v-model="message"></textarea>
                        </div>
                        <input type="button" :disabled="disabled" class="btn btn-primary form-control" value="Отправить" @click="send" />
                    </form>     
            `,
            props: {
                user: {
                    type: String
                }
            },
            data() {
                return {
                    message: '',
                    disabled: true,
                    messages: []
                }
            },
            created() {
                const socket = this.$options.socket = new SockJS('/ws');
                const stompClient = this.$options.stompClient = Stomp.over(socket);
                stompClient.connect({}, this.onConnected, this.onError);
            },
            methods: {
                onConnected(e) {
                    this.$options.stompClient.subscribe('/topic/chat/' + this.user, this.onMessageReceived);
                    this.disabled = false;
                },
                onError(e) {
                    console.error(e)
                },
                onMessageReceived(e) {
                    const data = JSON.parse(e.body);
                    this.messages.push({
                        date: new Date(data.time).toLocaleString(),
                        from: data.initiator,
                        message: data.message
                    })
                },
                async send() {
                    $.ajax({
                        url: '/api/chat/send',
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        data: JSON.stringify({
                            chat: dialog,
                            message: this.message
                        })
                    });

                    this.message = '';
                }
            }
        });

        const app = new Vue({
            el: '#app',
            data() {
                return {
                    login: 'admin1',
                    password: '123456'
                }
            },
            methods: {
                auth() {
                    $.ajax({
                        url: '/user/login',
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        dataType: 'json',
                        data: JSON.stringify({
                            login: this.login,
                            password: this.password
                        })
                    });
                }
            }
        })
    </script>
</body>
</html>
